<h4>Task 2: Write .NET code to connect to Azure Cosmos DB</h4>
<ol>
  <li>
    <p>
      Create a new
      <strong>AdventureWorks.Context/AdventureWorksCosmosContext.cs</strong>
      file in Visual Studio Code.
    </p>
  </li>
  <li>
    <p>
      Add the following <strong>using</strong> directives for libraries that
      will be referenced by the application:
    </p>
    <pre><code><code><div>using AdventureWorks.Models;
using Microsoft.Azure.Cosmos;
using Microsoft.Azure.Cosmos.Linq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
</div></code></code></pre>
  </li>
  <li>
    <p>
      Enter the following code to add an
      <strong>AdventureWorks.Context</strong> namespace block:
    </p>
    <pre><code><code><div>namespace AdventureWorks.Context
{
}
</div></code></code></pre>
  </li>
  <li>
    <p>
      Create a new <strong>AdventureWorksCosmosContext</strong> class that
      implements the <strong>IAdventureWorksProductContext</strong> interface
      with a single read-only <em>Container</em> variable:
    </p>
    <pre><code><code><div>public class AdventureWorksCosmosContext : IAdventureWorksProductContext
{
    private readonly Container _container;
}
</div></code></code></pre>
  </li>
  <li>
    <p>
      Within the <strong>AdventureWorksCosmosContext</strong> class, add a new
      constructor that creates a new instance of the
      <strong>CosmosClient</strong> class, and then obtain both a
      <strong>Database</strong> and <strong>Container</strong> instance from the
      client:
    </p>
    <pre><code><code><div>public AdventureWorksCosmosContext(string connectionString, string database = &quot;Retail&quot;, string container = &quot;Online&quot;)
{
    _container = new CosmosClient(connectionString)
        .GetDatabase(database)
        .GetContainer(container);
}
</div></code></code></pre>
  </li>
  <li>
    <p>
      Within the <strong>AdventureWorksCosmosContext</strong> class, add a new
      <strong>FindModelAsync</strong> method that creates a LINQ query,
      transforms it into an iterator, iterates over the result set, and then
      returns the single item in the result set:
    </p>
    <pre><code><code><div>public async Task&lt;Model&gt; FindModelAsync(Guid id)
{
    var iterator = _container.GetItemLinqQueryable&lt;Model&gt;()
        .Where(m =&gt; m.id == id)
        .ToFeedIterator&lt;Model&gt;();

    List&lt;Model&gt; matches = new List&lt;Model&gt;();
    while (iterator.HasMoreResults)
    {
        var next = await iterator.ReadNextAsync();
        matches.AddRange(next);
    }

    return matches.SingleOrDefault();
}
</div></code></code></pre>
  </li>
  <li>
    <p>
      Within the <strong>AdventureWorksCosmosContext</strong> class, add a new
      <strong>GetModelsAsync</strong> method that runs an SQL query, gets the
      query result iterator, iterates over the result set, and then returns the
      union of all results:
    </p>
    <pre><code><code><div>public async Task&lt;List&lt;Model&gt;&gt; GetModelsAsync()
{
    string query = $@&quot;SELECT * FROM items&quot;;

    var iterator = _container.GetItemQueryIterator&lt;Model&gt;(query);

    List&lt;Model&gt; matches = new List&lt;Model&gt;();
    while (iterator.HasMoreResults)
    {
        var next = await iterator.ReadNextAsync();
        matches.AddRange(next);
    }

    return matches;
}
</div></code></code></pre>
  </li>
  <li>
    <p>
      Within the <strong>AdventureWorksCosmosContext</strong> class, add a new
      <strong>FindProductAsync</strong> method that runs an SQL query, gets the
      query result iterator, iterates over the result set, and then returns the
      single item in the result set:
    </p>
    <pre><code><code><div>public async Task&lt;Product&gt; FindProductAsync(Guid id)
{
    string query = $@&quot;SELECT VALUE products
                        FROM models
                        JOIN products in models.Products
                        WHERE products.id = '{id}'&quot;;

    var iterator = _container.GetItemQueryIterator&lt;Product&gt;(query);

    List&lt;Product&gt; matches = new List&lt;Product&gt;();
    while (iterator.HasMoreResults)
    {
        var next = await iterator.ReadNextAsync();
        matches.AddRange(next);
    }

    return matches.SingleOrDefault();
}
</div></code></code></pre>
  </li>
  <li>
    <p>Save the <strong>AdventureWorksCosmosContext.cs</strong> file.</p>
  </li>
  <li>
    <p>
      Using a terminal, change your context to the
      <strong>AdventureWorks.Context</strong> folder:
    </p>
    <pre><code><code><div>cd .\AdventureWorks.Context\
</div></code></code></pre>
  </li>
  <li>
    <p>Using the same terminal, build the ASP.NET web application project:</p>
    <pre><code><code><div>dotnet build
</div></code></code></pre>
    <blockquote>
      <p>
        <strong>Note</strong>: If there are any build errors, review the
        <strong>AdventureWorksCosmosContext.cs</strong> file in the
        <strong
          >Allfiles
          (F):\Allfiles\Labs\04\Solution\AdventureWorks\AdventureWorks.Context</strong
        >
        folder.
      </p>
    </blockquote>
  </li>
  <li>
    <p>Close the current terminal.</p>
  </li>
</ol>
